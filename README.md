# Pokespeare

![Docker Hub](https://img.shields.io/docker/pulls/kipters/pokespeare)

An API that, given a PokÃ©mon name, returns its Shakespearean description.
The main application code lives in `src/Pokespeare`.

## Commit messages

This repo follows the [gitmoji](https://gitmoji.dev) convention with colon-coded
emojis.

## Development environment setup

### Visual Studio Code Dev Containers (preferred)

1. Install [Visual Studio Code](https://code.visualstudio.com/)
(doesn't work with forks like VSCodium)
1. Install [Docker](https://docs.docker.com/get-docker/) and
[Docker Compose](https://github.com/docker/compose)
1. Install the `Remote Development` extension pack
1. Open the repo
1. Confirm the request to open the workspace in a dev container
1. Redis cache will be automatically configured.

After a short build the environment will be ready with all the necessary tools
installed.

### GitHub Codespaces

1. Click on the green "Code" button
1. Click _Open in Codespaces_
1. If needed click on _New Codespace_
1. Redis cache will be automatically configured.

After a short wait your environment will be ready in the browser.

### Classic

1. Install the [.NET 5 SDK](https://dotnet.microsoft.com/download)
1. Install [`dotnet-format`](https://github.com/dotnet/format)
1. Install [Docker](https://docs.docker.com/get-docker/)
1. _Optional_: Set the `ConnectionStrings:Redis` configuration key to point to a
Redis instance, in the form `localhost:port`. If this connection string is not
present no caching will be used.

### Environment-independent steps
1. Navigate to `/src/Pokespeare` and set the FunTranslations API key to use
during development using the command
`dotnet user-secrets set FunTranslations:ShakespeareApiKey {apiKey}`, otherwise
unauthenticated requests will be used, which will likey result in
`TooManyRequests` errors.

When using either Dev Containers or Codespaces, an init script will copy the
(autogenerated) SSL certificate in the workspace root.

## Building

Running `dotnet build` in the repo root is enough to build the application.
To produce deployable artifacts run `dotnet publish src/Pokespeare`.

Refer to the respective `--help` subcommands for options.

## Running

When running on Visual Studio Code or Codespaces a launch profile is already 
provided and configured, just press F5.

From the command line, run `dotnet run -p src/Pokespeare`.

Default env vars and configuration are in 
`src/Pokespeare/properties/launchProfile.json`, append the `--no-launch-profile`
argument to ignore it or use `--launch-profile` to point to a different launch
profile.

Docker images for ARMv7, Aarch64 and x64 are available on Docker Hub:

```shell
docker pull kipters/pokespeare:latest
```

## Deploying

A Dockerfile is provided for builds. It uses the following build arguments:

- `IMAGE_TAG` selects which image tags to use for the base SDK and runtime-deps
images. Defaults to `5.0-alpine3.13`.
- `BUILD_ID`: set it to the CI pipeline ID. Its value will be added to the final
assembly Version string. Defaults to `local`.
- `COMMIT_ID`: set it the HEAD commit hash. Its value will be added to the final
assembly Version string. Defaults to `dirty`.
- `RUNTIME_ID`: Change it according to `IMAGE_TAG`. Selects the target RID for
the self-contained application build. Defaults to `alpine-x64`.

A separate Dockerfile (`Dockerfile-cross`) is provided for cross-building images
on different platforms.

To use it, you need a machine able to use qemu/KVM and which is running at least
Docker v19.

[Docker Buildx docs](https://docs.docker.com/buildx/working-with-buildx/)

If all requirements are met, create a build context with

`docker buildx create --use`

and build using the command

`docker buildx build --platform {platforms} -o type=oci,dest- -f Dockerfile-cross . > out.tar`

`platforms` is a comma-separated list of platforms to build for, supported ones
are `linux/arm`, `linux/arm64` and `linux/amd64`.

The resulting artifact will be a tarball containing all images in OCI format.

The same build arguments are supported, with the exception of `RUNTIME_ID` which
should not contain the architecture tag, thus its default will instead be just
`alpine`.

## API Documentation
When running on an environemnt configured as `Development`, OpenAPI
documentation will be available at the following paths:

- `/swagger` for human-friendly documentation.
- `/swagger/v1/swagger.json` for machine-readable documentation.

## Configuration

Refer to `src/Pokespeare/ConfigModels` for what configuration keys are used for
both remote services.
In addition to those, the application may use Redis as a caching mechanism if a
`hostname:port` pair is provided by the `ConnectionStrings:Redis` key.

During normal operation the container built by the Dockerfile only needs such
connection string and the FunTranslations API Key, usually passed via the
`CONNECTIONSTRINGS__REDIS` and `FUNTRANSLATIONS__SHAKESPEAREAPIKEY` environment
variables respectively.

As usual for .NET 5-based applications the `DOTNET_ENVIRONMENT` environment
variable controls the environment to configure the application for, valid
values are `Development` and `Production` with the latter being the default.

The only differences between them is that OpenAPI docs are only generated in
`Development` and developer-friendly error messages are given in responses,
including stack traces.

### Feature Flags

By default the application returns the first description in the list for any
given species, but a feature flag exists to change this behavior into
returning a random description among the ones for that species.
Its activation filter can be changed from Configuration. It's currently set
to enabled for 50% of requests.

## Logging

The project uses Serilog. Human-readable logs are output when running in
`Development`. Otherwise, JSON-serialized structured logs are used.

## TODO

- Abstractions are a bit too leaky
- The official Redis implementation of `IDistributedCache` is not using Redis
efficiently (it doesn't use the SETEX command for expiration)
- Add caching to descriptions retrieval from PokeApi
- Add circuit breakers for temporary outages on PokeApi and FunTranslations
- Add Github Actions
